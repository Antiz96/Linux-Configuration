##Install Debian 11 (bullseye) minimal (No DE, no standard or additionnal packages, nothing)

--If it's the very first install, remember to enable intel virtualization technology and disable secure boot in the BIOS--
https://rog.asus.com/us/support/FAQ/1043786
https://techzillo.com/how-to-disable-or-enable-secure-boot-for-asus-motherboard/

#Partitioning :
--System Disk-- (Without Nextcloud)
550 MB --> EFI Sytem
4G --> Swap
Left --> ext4 / (0% reserved block)
OR
--System Disk-- (With Nextcloud)
550 MB --> EFI Sytem
4G --> Swap
25G --> ext4 / (0% reserved block)
Left --> ext4 /data (0% reserved block)

--Storage Disk--
All space --> ext4 /storage (0% reserved block)


##Log as root

#Static IP Address (create the DNS record on Pihole)
$ vi /etc/network/interfaces
[...]
iface enp0s3 inet static
        address 192.168.1.100/24
        gateway 192.168.1.254
        dns-nameservers 192.168.1.1

$ systemctl restart networking

#Install sudo and put user in the sudo group
$ apt install sudo
$ usermod -aG sudo rcandau

#Create the Proxmox main directory in /storage
$ mkdir /storage/Proxmox


##Log as regular user

#Update the machine and install usefull packages (which I'll use to administrate the machine and perform various tasks. The selection is subjective tho)
$ sudo apt update && sudo apt full-upgrade
$ sudo apt install vim man bash-completion openssh-server mlocate htop curl telnet chrony ksmtuned ssh-askpass neofetch

#Configure ssh-askpass
$ sudo vim /etc/sudo.conf
[...]
# Sudo askpass:
Path askpass /usr/bin/ssh-askpass
[...]

#Download and edit my .bashrc
$ curl https://raw.githubusercontent.com/Antiz96/Linux-Customisation/master/Dotfiles/General/bashrc%20\(Debian-Ubuntu%20Based%20Distro%20SERVER%20-%20WSL\) -o ~/.bashrc
$ vim ~/.bashrc (delete all tmux part and flatpak in the fullupgrade alias)
$ source ~/.bashrc


##Install Proxmox
https://pve.proxmox.com/wiki/Install_Proxmox_VE_on_Debian_11_Bullseye
If you're facing a dependency problem during this isntall (dpkg deb error subprocess paste was killed by signal broken pipe), then : $ sudo dpkg -P qemu-system-data && sudo apt install -f
User Management Part : Create regular user in Datacenter --> Permissions --> User (Linux Pam authentication) and then, add PVEAdmin role in the main "Permission tab"
Linux Bridge Part : In Promox --> System --> Network, edit the actual network card and delete IP/Netmask and Gateway. Once done, create a new "Linux Bridge" card, add the IP/Netmask and Gateway and add the actual network card as the bridge port.


##Add storage for VMs and ISO via the Proxom interface
Datacenter --> Storage
ADD - Type : directory | ID : Backup | Directory : /storage/Proxmox/Backup | Content : VZDump Backup File
ADD - Type : directory | ID : ISO | Directory : /storage/Proxmox/ISO | Content : ISO Image
ADD - Type : directory | ID : VMs | Directory : /storage/Proxmox/VMs | Content : Disk Image
EDIT local directory --> uncheck "enabled" checkbox

##Disable the root account (for security reasons)
Log in to your regular PVEAdmin account
Datacenter --> Permissions --> User
EDIT root account --> uncheck "enabled" checkbox
(you can reactivate it the same way if you need it for some reasons)


##Additionnal configuration

#Modify proxmox repo from "enterprise" to "no-subscription" (as I do not use a subscription for my personal needs, I do not have a subscription key. Therefore, I cannot authenticate to the enterprise repo and use it, leading to an error "401 unauthorized" when performing "apt update").
https://drive.google.com/file/d/19hSC_O42fNMEZZUC-u2vSnqk02fEzGg_/view
$ sudo vim /etc/apt/sources.list.d/pve-enterprise.list
#deb https://enterprise.proxmox.com/debian/pve bullseye pve-enterprise
$ sudo vim /etc/apt/sources.list.d/pve-no-subscription.list
deb http://download.proxmox.com/debian bullseye pve-no-subscription

#Get rid of the "No valid subscription key found" message when loggin in (for the same reason as above)
https://johnscs.com/remove-proxmox51-subscription-notice/
$ sudo cp -p /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js-bck
$ sudo vim /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js 
--> Change "Ext.Msg.show" to "void"
[...]
void({
  title: gettext('No valid subscription'),
[...]
$ sudo systemctl restart pveproxy


##Useful informations/tips and general usage of the Proxmox interface

#Datacenter
Sum up --> Gives you a sum up of your datacenter state
Storage --> Manage, delete and create different storage type for different usage (ISO, VMs Disk, Backup, Container, Templates, etc...)
Backup --> Manage, delete, and create backup automatic jobs for your node/VMs
Permissions --> Manage, delete and create users, groups, roles, pools, API Token and realms. Also allow to enable and manage "Two Factor" authentication

#Proxmox (node)
Sum up --> Gives you a sum up of your node state
Shell --> Gives you a shell on your node (ssh)
System --> Gives you a sum up of the different services state
System/Network --> Manage, delete and create Network card, bridge, vlan, etc... (/etc/network/interfaces)
System/DNS --> Manage your DNS (/etc/resolv.conf)
System/Hosts --> Manage your hosts entry (/etc/hosts)
System/Time --> Manage your NTP configuration (chrony.conf)
System/Syslog --> Read the Proxmox's syslog in real time
Disks --> Shows your mounted disks
Tasks History --> Shows the history of tasks that has been performed recently on the node

#ISO (storage)
Sum up --> Gives you a sum up of your storage state
ISO Image --> Upload or Delete ISO(s). Note that you can only upload one ISO at once via the upload form. If I need to upload multiple ISOs from my computer to the Proxmox Server, I use the following command :
/!\It requires a Linux PC running an X11 (Xorg/X) based graphical interface/!\ 
/!\The "rsync" package has to be installed on both the source computer and the Proxmox Server (which should be the case as rsync is installed by default during the Promox installation)/!\
/!\Finally, it needs the "ssh-askpass" packages installed and configured on the Proxmox Server (see the "##Log as general user" part above)/!\
$ rsync -vzPhe "ssh -X" --rsync-path="sudo -A rsync" /run/media/rcandau/data/ISO/* rcandau@Promox:/storage/Promox/ISO/template/iso

#VMs (storage)
Sum up --> Gives you a sum up of your storage state
VMs Disks --> Manage (delete) VMs Disks

#Backup (storage)
Sum up --> Gives you a sum up of your storage state
Backup --> Manage your different backups (edit/restore/delete)

#Create a VM
Either click on "Create a VM" on the top right corner or in the right click menu of the Proxmox node

#VM
Sum up --> Gives you a sum up of your VM state
Console --> Gives you a remote console on your VM (VNC)
Hardware --> Manage, add, delete, edit or create hardware on the VM
Options --> Manage options of the VM
Tasks History --> Shows the history of tasks that has been performed recently on the VM
Backup --> Manager, delete, create or restore Backup of the VM
Snapshots --> Manage, delete, create or restore Snapshots of the VM

#Clone a VM
Either click on "Plus" menu at the top right corner while on your VM and select "Clone" or select "Clone" directly in the right click menu of the VM

#Delete a VM
Click on "Plus" at the top right corner while on your VM and select "Delete"


##Update/Upgrade procedure
Promox and its components are no more than regular packages installed on the Debian server.
So the update/upgrade procedure is basically just update/upgrade your system.

#Update Promox
$ sudo apt update && sudo apt full-upgrade

#Upgrade Proxmox
Proxmox upgrades usually follow Debian upgrade.
You have to fully update the system, change Debian and Proxmox repos to the new Debian version (for instance, from "buster" to "bullseye") and perform an update + dist-upgrade.
Usually, Proxmox write a wiki page/tutorial on how to upgrade from a major release to another, both for Debian and Proxmox at the same time

For instance, upgrade from "buster" to "bullseye" and from Proxmox v6 to Proxmox v7 :
https://pve.proxmox.com/wiki/Upgrade_from_6.x_to_7.0

If you prefer, you'll find video tutorial all over youtube :
https://www.youtube.com/watch?v=NLoY4vuTI6g& (French)
https://www.youtube.com/watch?v=RCSp6gT7LWs& (English)


##Reinstalling the Proxmox server without loosing VM
As VMs, ISOs and Backups are on a separate disk, I can actually completely reinstall my proxmox server without loosing any of my VMs, ISOs and Backups.
To do so, I just need to redo this whole procedure WITHOUT FORMATTING MY SECONDARY DISK (which contains VMs, ISOs and Backups), otherwise I'll loose everything. I just need to mount it to /storage during the partioning process. Also I do not need to create the /storage/Proxmox directory as it will already be created.
